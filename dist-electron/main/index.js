"use strict";const o=require("electron"),y=require("node:os"),m=require("node:path"),w=require("node:child_process"),D=require("crypto"),h=require("path"),S=require("fs"),E=require("https"),C=require("decompress"),I=require("os");process.env.DIST_ELECTRON=m.join(__dirname,"..");process.env.DIST=m.join(process.env.DIST_ELECTRON,"../dist");process.env.VITE_PUBLIC=process.env.VITE_DEV_SERVER_URL?m.join(process.env.DIST_ELECTRON,"../public/"):process.env.DIST;y.release().startsWith("6.1")&&o.app.disableHardwareAcceleration();process.platform==="win32"&&o.app.setAppUserModelId(o.app.getName());o.app.requestSingleInstanceLock()||(o.app.quit(),process.exit(0));console.log({electron:process.versions.electron,chrome:process.versions.chrome,node:process.versions.node,v8:process.versions.v8});let t=null;const q=m.join(__dirname,"../preload/index.js"),T=process.env.VITE_DEV_SERVER_URL,W=m.join(process.env.DIST,"index.html"),k=D.randomBytes(256),b=D.createHash("sha256").update(k,"utf8").digest("hex"),v=D.createHash("md5").update(k,"utf8").digest("hex"),x="testnet";var g=!1;async function P(){if(t=new o.BrowserWindow({title:"Navio X",center:!0,width:1100,height:820,backgroundColor:"#121212",transparent:!1,frame:!0,show:!0,hasShadow:!0,resizable:!0,vibrancy:process.platform==="darwin"?"ultra-dark":void 0,backgroundColor:"#00000000",icon:m.join(process.env.VITE_PUBLIC,"favicon.ico"),webPreferences:{preload:q,nodeIntegration:!0,contextIsolation:!1}}),t.once("ready-to-show",()=>{t.show()}),process.platform==="win32")try{t.setVibrancy("acrylic")}catch(e){console.log("Windows vibrancy not supported:",e.message)}t.setMenu(null),process.env.VITE_DEV_SERVER_URL?t.loadURL(T):t.loadFile(W),t.on("close",e=>{console.log("on-close"),console.log("is daemon binary started :"+g),g&&(console.log("stop-daemon fired"),e.preventDefault(),t.webContents.send("stop-daemon",5))}),t.webContents.on("did-finish-load",()=>{_(),t==null||t.webContents.send("main-process-message",new Date().toLocaleString())}),t.webContents.setWindowOpenHandler(({url:e})=>(e.startsWith("https:")&&o.shell.openExternal(e),{action:"deny"}))}o.app.whenReady().then(P);o.app.on("before-quit",e=>{g&&(console.log("before-quit"),e.preventDefault())});o.app.on("will-quit",e=>{g&&(console.log("will-quit"),e.preventDefault())});o.app.on("window-all-closed",()=>{t=null,process.platform!=="darwin"&&o.app.quit()});o.app.on("second-instance",()=>{t&&(t.isMinimized()&&t.restore(),t.focus())});o.app.on("activate",()=>{const e=o.BrowserWindow.getAllWindows();e.length?e[0].focus():P()});o.ipcMain.handle("get-bin-dir",()=>h.join(o.app.getPath("userData"),"bin"));o.ipcMain.handle("remove-bin-dir",async()=>{const e=require("fs"),n=require("path"),{app:u}=require("electron"),r=n.join(u.getPath("userData"),"bin");try{return e.existsSync(r)&&e.rmSync(r,{recursive:!0,force:!0}),{success:!0}}catch(p){return{success:!1,error:p.message}}});o.ipcMain.handle("start-daemon",e=>{_()});o.ipcMain.handle("start-staker",(e,n,u,r,p)=>{M(n,u,r,p)});o.ipcMain.handle("stop-staker",(e,n)=>{n&&R(n)});o.ipcMain.handle("shell-open-item",(e,n)=>{o.shell.showItemInFolder(`${n}`)});o.ipcMain.handle("shell-open-folder",async(e,n)=>await o.shell.openPath(n));o.ipcMain.handle("get-process-variables",async(e,n)=>({electron:process.versions.electron,chrome:process.versions.chrome,node:process.versions.node,v8:process.versions.v8}));o.ipcMain.handle("download-latest",async()=>{const e=I.platform();console.log("Platform:"+e);let n;e==="win32"&&(n="navio-latest-win64.zip"),e==="darwin"&&(n="navio-latest-x86_64-apple-darwin.tar.gz"),e==="linux"&&(n="navio-latest-x86_64-linux-gnu.tar.gz");const u={filename:n,platform:e};if(t.webContents.send("download-file",u),!n){t.webContents.send("download-error","No file suitable for the platform was found.");return}const r=`https://releases.nav.io/${n}`,p=h.join(o.app.getPath("downloads"),h.basename(n));try{await j(r,p,s=>{console.log("Progress:"+s),t.webContents.send("download-progress",s)});const c=h.join(o.app.getPath("userData"),"bin");return await S.promises.mkdir(c,{recursive:!0}),await C(p,c,{filter:s=>s.path.includes("/bin/")||s.path.startsWith("bin/"),map:s=>{const a=s.path.split("/"),d=a.indexOf("bin");return d!==-1&&(s.path=a.slice(d+1).join("/")),s}}),c}catch(c){let s="An error occurred.";return c.code==="ENOTFOUND"?s="Could not connect to url : "+r:c.response&&c.response.status===404?s="File not found (404) : "+r:c.code==="ECONNREFUSED"?s="Connection refused.":c.message&&(s=c.message),console.error("Download error:",s),t.webContents.send("download-error",s),null}});function j(e,n,u){return new Promise((r,p)=>{const c=S.createWriteStream(n);E.get(e,s=>{if(s.statusCode===404)return p({response:{status:404}});const a=parseInt(s.headers["content-length"],10);let d=0;s.pipe(c),s.on("data",f=>{if(d+=f.length,u&&a){const i=Math.round(d/a*100);u(i)}}),c.on("finish",()=>{c.close(r)})}).on("error",s=>{p(s)})})}function _(){const e={win32:"naviod.exe",linux:"naviod",darwin:"naviod"},n=h.join(o.app.getPath("userData"),"bin"),u=e[process.platform];if(!u){console.error("Unsupported platform:",process.platform);return}const r=h.join(n,u);if(console.log("Starting daemon..."),console.log("Platform : "+process.platform),console.log("Architecture : "+process.arch),console.log("App Path : "+o.app.getAppPath()),console.log("Bin directory : "+n),console.log("Executable path : "+r),S.mkdirSync(n,{recursive:!0}),S.existsSync(r))console.error("Daemon binary found:",r);else{console.error("Daemon binary not found:",r),g=!1,t.webContents.send("is-daemon-started",{started:!1,error:"binary_not_found",path:r,network:x,rpcuser:b,rpcpassword:v});return}const p=[`--${x}`,"--printtoconsole","--walletcrosschain","-rpcworkqueue=64",`-rpcuser=${b}`,`-rpcpassword=${v}`,"-txindex=1","-addnode=testnet-navio.nav.community","-debug=1","-debugexclude=libevent","-debugexclude=http","-debugexclude=rpc","-debugexclude=leveldb","-debugexclude=bench","-debugexclude=net","-debugexclude=addrman"];console.log("Daemon Parameters : ["+p+"]");const c={cwd:n,env:process.env,shell:!1,windowsVerbatimArguments:process.platform==="win32"},s=()=>{console.log("Executable:",r),console.log("Params:",p.join(" "));const a=w.spawn(r,p,c);a.on("error",d=>{g=!1,console.error("Daemon start failed:",d),t.webContents.send("is-daemon-started",{started:!1,network:x,rpcuser:b,rpcpassword:v})}),a.on("exit",d=>{g=!1,console.log("Daemon exited with code:",d),o.app.quit(),process.exit(0)}),a.stdout.on("data",d=>{const f=d.toString();console.log("*",f),f.includes("Starting HTTP server")&&(g=!0,t.webContents.send("is-daemon-started",{started:!0,network:x,rpcuser:b,rpcpassword:v}))}),a.stderr.on("data",d=>{const f=d.toString();f.startsWith("Warning")||console.error("stderr:",f)})};process.platform==="linux"||process.platform==="darwin"?w.execFile("chmod",["+x",r],a=>{if(a){console.error("chmod failed:",a);return}s()}):s()}function R(e){console.log("Stopping staker. PID : "+e),process.kill(e,"SIGTERM")}function M(e,n,u,r){console.log("Starting staker..."),console.log(`${e}`),console.log(`${n}`),console.log(`${u}`),console.log(`${r}`);let p=h.join(o.app.getPath("userData"),"bin"),c=process.platform!=="win32",s={linux:"navio-staker",darwin:"navio-staker",win32:"navio-staker.exe"},a=h.join(p,s[process.platform]);var d=["-"+e,"-wallet="+n,"-rpcuser="+u,"-rpcpassword="+r];console.log("Binary Parameters : ["+d+"]");const f={cwd:p,env:process.env,shell:c,windowsVerbatimArguments:!0};console.log("Platform : "+process.platform),console.log("App Path : "+o.app.getAppPath()),console.log("Architecture : "+process.arch);var i;process.platform==="linux"||process.platform==="darwin"?(console.log("Setting staker file as executable "+a),w.execFile("chmod",["+x",a],f,function(){i=w.spawn(a,d,f),i.on("error",l=>{console.log("Failed to start staker->"+a+"->"+l.message)}),i.pid?(t.webContents.send("start-staker-success",i.pid),console.log("Staker started. PID:"+i.pid),i.on("exit",l=>{i=null,t.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+l)}),i.stdout.on("data",l=>{console.log(l.toString())}),i.stderr.on("data",l=>{console.log("stderr : "+l),l.toString().startsWith("Warning")||console.log("Staker start failed->"+l.toString())})):console.log("Staker start failed.")})):(console.log(a),i=w.spawn(a,d,f),i.on("error",l=>{console.log("Failed to start staker."+l.message),console.log(l)}),i.pid?(t.webContents.send("start-staker-success",i.pid),console.log("Staker started. PID:"+i.pid),i.on("exit",l=>{i=null,t.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+l)}),i.stdout.on("data",l=>{console.log(l.toString())}),i.stderr.on("data",l=>{console.log("stderr : "+l),l.toString().startsWith("Warning")||console.log("Staker start failed",l.toString())})):console.log("Staker start failed."))}
