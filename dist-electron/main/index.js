"use strict";const o=require("electron"),E=require("node:os"),h=require("node:path"),w=require("node:child_process"),D=require("crypto"),m=require("path"),S=require("fs"),y=require("https"),C=require("decompress"),I=require("os");process.env.DIST_ELECTRON=h.join(__dirname,"..");process.env.DIST=h.join(process.env.DIST_ELECTRON,"../dist");process.env.VITE_PUBLIC=process.env.VITE_DEV_SERVER_URL?h.join(process.env.DIST_ELECTRON,"../public/"):process.env.DIST;E.release().startsWith("6.1")&&o.app.disableHardwareAcceleration();process.platform==="win32"&&o.app.setAppUserModelId(o.app.getName());o.app.requestSingleInstanceLock()||(o.app.quit(),process.exit(0));let s=null;const q=h.join(__dirname,"../preload/index.js"),T=process.env.VITE_DEV_SERVER_URL,W=h.join(process.env.DIST,"index.html"),k=D.randomBytes(256),b=D.createHash("sha256").update(k,"utf8").digest("hex"),x=D.createHash("md5").update(k,"utf8").digest("hex"),v="testnet";var g=!1;async function P(){if(s=new o.BrowserWindow({title:"Main window",width:1100,height:760,transparent:!1,frame:!0,hasShadow:!0,resizable:!0,vibrancy:process.platform==="darwin"?"ultra-dark":void 0,backgroundColor:"#00000000",icon:h.join(process.env.VITE_PUBLIC,"favicon.ico"),webPreferences:{preload:q,nodeIntegration:!0,contextIsolation:!1}}),process.platform==="win32")try{s.setVibrancy("acrylic")}catch(e){console.log("Windows vibrancy not supported:",e.message)}s.setMenu(null),process.env.VITE_DEV_SERVER_URL?s.loadURL(T):s.loadFile(W),s.on("close",e=>{console.log("on-close"),console.log("is daemon binary started :"+g),g&&(console.log("stop-daemon fired"),e.preventDefault(),s.webContents.send("stop-daemon",5))}),s.webContents.on("did-finish-load",()=>{_(),s==null||s.webContents.send("main-process-message",new Date().toLocaleString())}),s.webContents.setWindowOpenHandler(({url:e})=>(e.startsWith("https:")&&o.shell.openExternal(e),{action:"deny"}))}o.app.whenReady().then(P);o.app.on("before-quit",e=>{g&&(console.log("before-quit"),e.preventDefault())});o.app.on("will-quit",e=>{g&&(console.log("will-quit"),e.preventDefault())});o.app.on("window-all-closed",()=>{s=null,process.platform!=="darwin"&&o.app.quit()});o.app.on("second-instance",()=>{s&&(s.isMinimized()&&s.restore(),s.focus())});o.app.on("activate",()=>{const e=o.BrowserWindow.getAllWindows();e.length?e[0].focus():P()});o.ipcMain.handle("get-bin-dir",()=>m.join(o.app.getPath("userData"),"bin"));o.ipcMain.handle("remove-bin-dir",async()=>{const e=require("fs"),t=require("path"),{app:u}=require("electron"),r=t.join(u.getPath("userData"),"bin");try{return e.existsSync(r)&&e.rmSync(r,{recursive:!0,force:!0}),{success:!0}}catch(p){return{success:!1,error:p.message}}});o.ipcMain.handle("start-daemon",e=>{_()});o.ipcMain.handle("start-staker",(e,t,u,r,p)=>{M(t,u,r,p)});o.ipcMain.handle("stop-staker",(e,t)=>{t&&R(t)});o.ipcMain.handle("shell-open-item",(e,t)=>{o.shell.showItemInFolder(`${t}`)});o.ipcMain.handle("shell-open-folder",async(e,t)=>await o.shell.openPath(t));o.ipcMain.handle("download-latest",async()=>{const e=I.platform();console.log("Platform:"+e);let t;e==="win32"&&(t="navio-latest-win64.zip"),e==="darwin"&&(t="navio-latest-x86_64-apple-darwin.tar.gz"),e==="linux"&&(t="navio-latest-x86_64-linux-gnu.tar.gz");const u={filename:t,platform:e};if(s.webContents.send("download-file",u),!t){s.webContents.send("download-error","No file suitable for the platform was found.");return}const r=`https://releases.nav.io/${t}`,p=m.join(o.app.getPath("downloads"),m.basename(t));try{await j(r,p,n=>{console.log("Progress:"+n),s.webContents.send("download-progress",n)});const c=m.join(o.app.getPath("userData"),"bin");return await S.promises.mkdir(c,{recursive:!0}),await C(p,c,{filter:n=>n.path.includes("/bin/")||n.path.startsWith("bin/"),map:n=>{const a=n.path.split("/"),d=a.indexOf("bin");return d!==-1&&(n.path=a.slice(d+1).join("/")),n}}),c}catch(c){let n="An error occurred.";return c.code==="ENOTFOUND"?n="Could not connect to url : "+r:c.response&&c.response.status===404?n="File not found (404) : "+r:c.code==="ECONNREFUSED"?n="Connection refused.":c.message&&(n=c.message),console.error("Download error:",n),s.webContents.send("download-error",n),null}});function j(e,t,u){return new Promise((r,p)=>{const c=S.createWriteStream(t);y.get(e,n=>{if(n.statusCode===404)return p({response:{status:404}});const a=parseInt(n.headers["content-length"],10);let d=0;n.pipe(c),n.on("data",f=>{if(d+=f.length,u&&a){const i=Math.round(d/a*100);u(i)}}),c.on("finish",()=>{c.close(r)})}).on("error",n=>{p(n)})})}function _(){const e={win32:"naviod.exe",linux:"naviod",darwin:"naviod"},t=m.join(o.app.getPath("userData"),"bin"),u=e[process.platform];if(!u){console.error("Unsupported platform:",process.platform);return}const r=m.join(t,u);if(console.log("Starting daemon..."),console.log("Platform : "+process.platform),console.log("Architecture : "+process.arch),console.log("App Path : "+o.app.getAppPath()),console.log("Bin directory : "+t),console.log("Executable path : "+r),S.mkdirSync(t,{recursive:!0}),S.existsSync(r))console.error("Daemon binary found:",r);else{console.error("Daemon binary not found:",r),g=!1,s.webContents.send("is-daemon-started",{started:!1,error:"binary_not_found",path:r,network:v,rpcuser:b,rpcpassword:x});return}const p=[`--${v}`,"--printtoconsole","--walletcrosschain","-rpcworkqueue=64",`-rpcuser=${b}`,`-rpcpassword=${x}`,"-txindex=1","-addnode=testnet-navio.nav.community","-debug=1","-debugexclude=libevent","-debugexclude=http","-debugexclude=rpc","-debugexclude=leveldb","-debugexclude=bench","-debugexclude=net","-debugexclude=addrman"];console.log("Daemon Parameters : ["+p+"]");const c={cwd:t,env:process.env,shell:!1,windowsVerbatimArguments:process.platform==="win32"},n=()=>{console.log("Executable:",r),console.log("Params:",p.join(" "));const a=w.spawn(r,p,c);a.on("error",d=>{g=!1,console.error("Daemon start failed:",d),s.webContents.send("is-daemon-started",{started:!1,network:v,rpcuser:b,rpcpassword:x})}),a.on("exit",d=>{g=!1,console.log("Daemon exited with code:",d),o.app.quit(),process.exit(0)}),a.stdout.on("data",d=>{const f=d.toString();console.log("*",f),f.includes("Starting HTTP server")&&(g=!0,s.webContents.send("is-daemon-started",{started:!0,network:v,rpcuser:b,rpcpassword:x}))}),a.stderr.on("data",d=>{const f=d.toString();f.startsWith("Warning")||console.error("stderr:",f)})};process.platform==="linux"||process.platform==="darwin"?w.execFile("chmod",["+x",r],a=>{if(a){console.error("chmod failed:",a);return}n()}):n()}function R(e){console.log("Stopping staker. PID : "+e),process.kill(e,"SIGTERM")}function M(e,t,u,r){console.log("Starting staker..."),console.log(`${e}`),console.log(`${t}`),console.log(`${u}`),console.log(`${r}`);let p=m.join(o.app.getPath("userData"),"bin"),c=process.platform!=="win32",n={linux:"navio-staker",darwin:"navio-staker",win32:"navio-staker.exe"},a=m.join(p,n[process.platform]);var d=["-"+e,"-wallet="+t,"-rpcuser="+u,"-rpcpassword="+r];console.log("Binary Parameters : ["+d+"]");const f={cwd:p,env:process.env,shell:c,windowsVerbatimArguments:!0};console.log("Platform : "+process.platform),console.log("App Path : "+o.app.getAppPath()),console.log("Architecture : "+process.arch);var i;process.platform==="linux"||process.platform==="darwin"?(console.log("Setting staker file as executable "+a),w.execFile("chmod",["+x",a],f,function(){i=w.spawn(a,d,f),i.on("error",l=>{console.log("Failed to start staker->"+a+"->"+l.message)}),i.pid?(s.webContents.send("start-staker-success",i.pid),console.log("Staker started. PID:"+i.pid),i.on("exit",l=>{i=null,s.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+l)}),i.stdout.on("data",l=>{console.log(l.toString())}),i.stderr.on("data",l=>{console.log("stderr : "+l),l.toString().startsWith("Warning")||console.log("Staker start failed->"+l.toString())})):console.log("Staker start failed.")})):(console.log(a),i=w.spawn(a,d,f),i.on("error",l=>{console.log("Failed to start staker."+l.message),console.log(l)}),i.pid?(s.webContents.send("start-staker-success",i.pid),console.log("Staker started. PID:"+i.pid),i.on("exit",l=>{i=null,s.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+l)}),i.stdout.on("data",l=>{console.log(l.toString())}),i.stderr.on("data",l=>{console.log("stderr : "+l),l.toString().startsWith("Warning")||console.log("Staker start failed",l.toString())})):console.log("Staker start failed."))}
