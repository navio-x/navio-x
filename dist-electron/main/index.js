"use strict";const o=require("electron"),I=require("node:os"),h=require("node:path"),x=require("node:child_process"),D=require("crypto"),w=require("path"),k=require("fs"),q=require("https"),T=require("decompress"),W=require("os");process.env.DIST_ELECTRON=h.join(__dirname,"..");process.env.DIST=h.join(process.env.DIST_ELECTRON,"../dist");process.env.VITE_PUBLIC=process.env.VITE_DEV_SERVER_URL?h.join(process.env.DIST_ELECTRON,"../public/"):process.env.DIST;I.release().startsWith("6.1")&&o.app.disableHardwareAcceleration();process.platform==="win32"&&o.app.setAppUserModelId(o.app.getName());o.app.requestSingleInstanceLock()||(o.app.quit(),process.exit(0));let s=null;const R=h.join(__dirname,"../preload/index.js"),M=process.env.VITE_DEV_SERVER_URL,j=h.join(process.env.DIST,"index.html"),P=D.randomBytes(256),S=D.createHash("sha256").update(P,"utf8").digest("hex"),v=D.createHash("md5").update(P,"utf8").digest("hex"),_="testnet";var m=!1;async function y(){if(s=new o.BrowserWindow({title:"Main window",width:1100,height:760,transparent:!1,frame:!0,hasShadow:!0,resizable:!0,vibrancy:process.platform==="darwin"?"ultra-dark":void 0,backgroundColor:"#00000000",icon:h.join(process.env.VITE_PUBLIC,"favicon.ico"),webPreferences:{preload:R,nodeIntegration:!0,contextIsolation:!1}}),process.platform==="win32")try{s.setVibrancy("acrylic")}catch(e){console.log("Windows vibrancy not supported:",e.message)}s.setMenu(null),process.env.VITE_DEV_SERVER_URL?s.loadURL(M):s.loadFile(j),s.on("close",e=>{console.log("on-close"),console.log("is daemon binary started :"+m),m&&(console.log("stop-daemon fired"),e.preventDefault(),s.webContents.send("stop-daemon",5))}),s.webContents.on("did-finish-load",()=>{E(),s==null||s.webContents.send("main-process-message",new Date().toLocaleString())}),s.webContents.setWindowOpenHandler(({url:e})=>(e.startsWith("https:")&&o.shell.openExternal(e),{action:"deny"}))}o.app.whenReady().then(y);o.app.on("before-quit",e=>{m&&(console.log("before-quit"),e.preventDefault())});o.app.on("will-quit",e=>{m&&(console.log("will-quit"),e.preventDefault())});o.app.on("window-all-closed",()=>{s=null,process.platform!=="darwin"&&o.app.quit()});o.app.on("second-instance",()=>{s&&(s.isMinimized()&&s.restore(),s.focus())});o.app.on("activate",()=>{const e=o.BrowserWindow.getAllWindows();e.length?e[0].focus():y()});o.ipcMain.handle("get-bin-dir",()=>w.join(o.app.getPath("userData"),"bin"));o.ipcMain.handle("remove-bin-dir",async()=>{const e=require("fs"),n=require("path"),{app:u}=require("electron"),a=n.join(u.getPath("userData"),"bin");try{return e.existsSync(a)&&e.rmSync(a,{recursive:!0,force:!0}),{success:!0}}catch(c){return{success:!1,error:c.message}}});o.ipcMain.handle("start-daemon",e=>{E()});o.ipcMain.handle("start-staker",(e,n,u,a,c)=>{L(n,u,a,c)});o.ipcMain.handle("stop-staker",(e,n)=>{n&&A(n)});o.ipcMain.handle("shell-open-item",(e,n)=>{o.shell.showItemInFolder(`${n}`)});o.ipcMain.handle("shell-open-folder",async(e,n)=>await o.shell.openPath(n));o.ipcMain.handle("download-latest",async()=>{const e=W.platform();console.log("Platform:"+e);let n;e==="win32"&&(n="navio-latest-win64.zip"),e==="darwin"&&(n="navio-latest-x86_64-apple-darwin.tar.gz"),e==="linux"&&(n="navio-latest-x86_64-linux-gnu.tar.gz");const u={filename:n,platform:e};if(s.webContents.send("download-file",u),!n){s.webContents.send("download-error","No file suitable for the platform was found.");return}const a=`https://releases.nav.io/${n}`,c=w.join(o.app.getPath("downloads"),w.basename(n));try{await V(a,c,t=>{console.log("Progress:"+t),s.webContents.send("download-progress",t)});const r=w.join(o.app.getPath("userData"),"bin");return await k.promises.mkdir(r,{recursive:!0}),await T(c,r,{filter:t=>t.path.includes("/bin/")||t.path.startsWith("bin/"),map:t=>{const l=t.path.split("/"),i=l.indexOf("bin");return i!==-1&&(t.path=l.slice(i+1).join("/")),t}}),r}catch(r){let t="An error occurred.";return r.code==="ENOTFOUND"?t="Could not connect to url : "+a:r.response&&r.response.status===404?t="File not found (404) : "+a:r.code==="ECONNREFUSED"?t="Connection refused.":r.message&&(t=r.message),console.error("Download error:",t),s.webContents.send("download-error",t),null}});function V(e,n,u){return new Promise((a,c)=>{const r=k.createWriteStream(n);q.get(e,t=>{if(t.statusCode===404)return c({response:{status:404}});const l=parseInt(t.headers["content-length"],10);let i=0;t.pipe(r),t.on("data",g=>{if(i+=g.length,u&&l){const b=Math.round(i/l*100);u(b)}}),r.on("finish",()=>{r.close(a)})}).on("error",t=>{c(t)})})}function E(){const e={win32:"naviod.exe",linux:"naviod",darwin:"naviod"},n=w.join(o.app.getPath("userData"),"bin"),u=e[process.platform];if(!u){console.error("Unsupported platform:",process.platform);return}const a=w.join(n,u);if(console.log("Starting daemon..."),console.log("Platform : "+process.platform),console.log("Architecture : "+process.arch),console.log("App Path : "+o.app.getAppPath()),console.log("Bin directory : "+n),console.log("Executable path : "+a),k.mkdirSync(n,{recursive:!0}),k.existsSync(a))console.error("Daemon binary found:",a);else{console.error("Daemon binary not found:",a),m=!1,s.webContents.send("is-daemon-started",{started:!1,error:"binary_not_found",path:a,network:_,rpcuser:S,rpcpassword:v});return}const c=[`--${_}`,"--printtoconsole","--walletcrosschain","-rpcworkqueue=64",`-rpcuser=${S}`,`-rpcpassword=${v}`,"-txindex=1","-addnode=testnet-navio.nav.community","-debug=1","-debugexclude=libevent","-debugexclude=http","-debugexclude=rpc","-debugexclude=leveldb","-debugexclude=bench","-debugexclude=net","-debugexclude=addrman"];console.log("Daemon Parameters : ["+c+"]");const r={cwd:n,env:process.env,shell:!1,windowsVerbatimArguments:process.platform==="win32"},t=()=>{console.log("Executable:",a),console.log("Params:",c.join(" "));const l=x.spawn(a,c,r);l.on("error",i=>{m=!1,console.error("Daemon start failed:",i),s.webContents.send("is-daemon-started",{started:!1,network:_,rpcuser:S,rpcpassword:v})}),l.on("exit",i=>{m=!1,console.log("Daemon exited with code:",i),o.app.quit(),process.exit(0)}),l.stdout.on("data",i=>{const g=i.toString();console.log("*",g),g.includes("Starting HTTP server")&&(m=!0,s.webContents.send("is-daemon-started",{started:!0,network:_,rpcuser:S,rpcpassword:v}))}),l.stderr.on("data",i=>{const g=i.toString();g.startsWith("Warning")||console.error("stderr:",g)})};process.platform==="linux"||process.platform==="darwin"?x.execFile("chmod",["+x",a],l=>{if(l){console.error("chmod failed:",l);return}t()}):t()}function A(e){console.log("Stopping staker. PID : "+e),process.kill(e,"SIGTERM")}function L(e,n,u,a){console.log("Starting staker..."),console.log(`${e}`),console.log(`${n}`),console.log(`${u}`),console.log(`${a}`);let c=!1,r=__dirname;process.platform==="win32"&&(r+="\\"),process.platform==="darwin"&&(r+="/"),process.platform==="linux"&&(r+="/"),r+="bin";let t="",l={f_linux:"navio-staker",f_osx:"navio-staker",f_windows:"navio-staker.exe"},i="";process.platform=="win32"&&(i=r+"\\"+l.f_windows,c=!1),process.platform=="linux"&&(i=r+"/./"+l.f_linux,c=!0),process.platform=="darwin"&&(i=r+"/./"+l.f_osx,c=!0);var g=["-"+e+" -wallet="+n+" -rpcuser="+u+" -rpcpassword="+a];console.log("Binary Parameters : ["+g+"]");const b={cwd:r,env:process.env,shell:c,windowsVerbatimArguments:!0};console.log("Platform : "+process.platform),console.log("App Path : "+o.app.getAppPath()),console.log("Architecture : "+process.arch);var d;process.platform=="linux"||process.platform=="darwin"?(process.platform=="linux"&&(t=r+"/"+l.f_linux),process.platform=="darwin"&&(t=r+"/"+l.f_osx),console.log("Setting staker file as executable "+t),x.execFile("chmod +x "+t,null,b,function(p,C){d=x.spawn(i,g,b,function(f,U){f&&(console.log(f),console.log("Staker start failed->"+i+"->"+f.message))}),d.on("error",f=>{console.log("Failed to start staker->"+i+"->"+f.message)}),d.pid!=null?(s.webContents.send("start-staker-success",d.pid),console.log("Staker started. PID:"+d.pid),d.on("exit",f=>{d=null,s.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+f)}),d.stdout.on("data",f=>{console.log(f.toString())}),d.stderr.on("data",function(f){console.log("stderr : "+f),f.toString().startsWith("Warning")||console.log("Staker start failed->"+f.toString())})):console.log("Staker start failed.")})):(console.log(i),d=x.spawn(l.f_windows,g,b,function(p,C){p&&(console.log(p),console.log("Staker start failed -> "+p.message))}),d.on("error",p=>{console.log("Failed to start staker."+p.message),console.log(p)}),d.pid!=null?(s.webContents.send("start-staker-success",d.pid),console.log("Staker started. PID:"+d.pid),d.on("exit",p=>{d=null,s.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+p)}),d.stdout.on("data",p=>{console.log(p.toString())}),d.stderr.on("data",function(p){console.log("stderr : "+p),p.toString().startsWith("Warning")||console.log("Staker start failed",p.toString())})):console.log("Staker start failed."))}
