"use strict";const l=require("electron"),q=require("node:os"),S=require("node:path"),_=require("node:child_process"),k=require("crypto"),v=require("path"),C=require("fs"),y=require("https"),W=require("decompress"),T=require("os");process.env.DIST_ELECTRON=S.join(__dirname,"..");process.env.DIST=S.join(process.env.DIST_ELECTRON,"../dist");process.env.VITE_PUBLIC=process.env.VITE_DEV_SERVER_URL?S.join(process.env.DIST_ELECTRON,"../public/"):process.env.DIST;q.release().startsWith("6.1")&&l.app.disableHardwareAcceleration();process.platform==="win32"&&l.app.setAppUserModelId(l.app.getName());l.app.requestSingleInstanceLock()||(l.app.quit(),process.exit(0));let s=null;const F=S.join(__dirname,"../preload/index.js"),R=process.env.VITE_DEV_SERVER_URL,V=S.join(process.env.DIST,"index.html"),D=k.randomBytes(256),m=k.createHash("sha256").update(D,"utf8").digest("hex"),h=k.createHash("md5").update(D,"utf8").digest("hex"),b="testnet";var g=!1;async function E(){if(s=new l.BrowserWindow({title:"Main window",width:1100,height:760,transparent:!1,frame:!0,hasShadow:!0,resizable:!0,vibrancy:process.platform==="darwin"?"ultra-dark":void 0,backgroundColor:"#00000000",icon:S.join(process.env.VITE_PUBLIC,"favicon.ico"),webPreferences:{preload:F,nodeIntegration:!0,contextIsolation:!1}}),process.platform==="win32")try{s.setVibrancy("acrylic")}catch(e){console.log("Windows vibrancy not supported:",e.message)}s.setMenu(null),process.env.VITE_DEV_SERVER_URL?s.loadURL(R):s.loadFile(V),s.on("close",e=>{console.log("on-close"),console.log("is daemon binary started :"+g),g&&(console.log("stop-daemon fired"),e.preventDefault(),s.webContents.send("stop-daemon",5))}),s.webContents.on("did-finish-load",()=>{P(),s==null||s.webContents.send("main-process-message",new Date().toLocaleString())}),s.webContents.setWindowOpenHandler(({url:e})=>(e.startsWith("https:")&&l.shell.openExternal(e),{action:"deny"}))}l.app.whenReady().then(E);l.app.on("before-quit",e=>{g&&(console.log("before-quit"),e.preventDefault())});l.app.on("will-quit",e=>{g&&(console.log("will-quit"),e.preventDefault())});l.app.on("window-all-closed",()=>{s=null,process.platform!=="darwin"&&l.app.quit()});l.app.on("second-instance",()=>{s&&(s.isMinimized()&&s.restore(),s.focus())});l.app.on("activate",()=>{const e=l.BrowserWindow.getAllWindows();e.length?e[0].focus():E()});l.ipcMain.handle("start-daemon",e=>{P()});l.ipcMain.handle("start-staker",(e,n,d,p,a)=>{L(n,d,p,a)});l.ipcMain.handle("stop-staker",(e,n)=>{M(n)});l.ipcMain.handle("shell-open-item",(e,n)=>{l.shell.showItemInFolder(`${n}`)});l.ipcMain.handle("download-latest",async()=>{const e=T.platform();console.log("Platform:"+e);let n;if(e==="win32"&&(n="navio-latest-win64.zip"),e==="darwin"&&(n="navio-latest-x86_64-apple-darwin.tar.gz"),e==="linux"&&(n="navio-latest-x86_64-linux-gnu.tar.gz"),!n){s.webContents.send("download-error","No file suitable for the platform was found.");return}const d=`https://releases.nav.io/${n}`,p=v.join(l.app.getPath("downloads"),v.basename(n));try{await A(d,p,o=>{console.log("Progress:"+o),s.webContents.send("download-progress",o)});const a=v.join(__dirname,"bin");return await C.promises.mkdir(a,{recursive:!0}),await W(p,a,{filter:o=>o.path.includes("/bin/")||o.path.startsWith("bin/"),map:o=>{const c=o.path.split("/"),f=c.indexOf("bin");return f!==-1&&(o.path=c.slice(f+1).join("/")),o}}),a}catch(a){let o="An error occurred.";return a.code==="ENOTFOUND"?o="Could not connect to url : "+d:a.response&&a.response.status===404?o="File not found (404) : "+d:a.code==="ECONNREFUSED"?o="Connection refused.":a.message&&(o=a.message),console.error("Download error:",o),s.webContents.send("download-error",o),null}});function A(e,n,d){return new Promise((p,a)=>{const o=C.createWriteStream(n);y.get(e,c=>{if(c.statusCode===404)return a({response:{status:404}});const f=parseInt(c.headers["content-length"],10);let r=0;c.pipe(o),c.on("data",i=>{if(r+=i.length,d&&f){const x=Math.round(r/f*100);d(x)}}),o.on("finish",()=>{o.close(p)})}).on("error",c=>{a(c)})})}function P(){console.log("Starting daemon...");let e=!1,n=__dirname;process.platform==="win32"&&(n+="\\"),process.platform==="darwin"&&(n+="/"),process.platform==="linux"&&(n+="/"),n+="bin";let d="",p={f_linux:"naviod",f_osx:"naviod",f_windows:"naviod.exe"},a="";process.platform=="win32"&&(a=n+"\\"+p.f_windows,e=!1),process.platform=="linux"&&(a=n+"/./"+p.f_linux,e=!0),process.platform=="darwin"&&(a=n+"/./"+p.f_osx,e=!0);const o="Starting HTTP server",c={cwd:n,env:process.env,shell:e,windowsVerbatimArguments:!0};var f=["--"+b+" --printtoconsole --walletcrosschain -rpcworkqueue=64 -rpcuser="+m+" -rpcpassword="+h+" -txindex=1 -addnode=testnet-navio.nav.community -debug=1 -debugexclude=libevent -debugexclude=http -debugexclude=rpc -debugexclude=leveldb -debugexclude=bench -debugexclude=net -debugexclude=addrman"];console.log("Daemon Parameters : ["+f+"]"),console.log("Platform : "+process.platform),console.log("Architecture : "+process.arch),console.log("App Path : "+l.app.getAppPath());var r;process.platform=="linux"||process.platform=="darwin"?(process.platform=="linux"&&(d=n+"/"+p.f_linux),process.platform=="darwin"&&(d=n+"/"+p.f_osx),console.log("Setting daemon file as executable "+d),_.execFile("chmod +x "+d,null,c,function(i,x){r=_.spawn(a,f,c,function(t,u){t&&(g=!1,console.log(t),console.log("Failed to start daemon->"+a+"->"+t.message))}),r.on("error",t=>{g=!1,console.log("Failed to start daemon->"+a+"->"+t.message),s.webContents.send("is-daemon-started",{started:!1,network:b,rpcuser:m,rpcpassword:h})}),r.pid!=null?(g=!0,console.log("Daemon started. PID:"+r.pid),r.on("exit",t=>{g&&(r=null,t!=127?(console.log("Daemon stopped. Exit Code : "+t),l.app.quit(),process.exit(0)):(g=!1,console.log("Daemon binary not found."),s.webContents.send("is-daemon-started",{started:!1,network:b,rpcuser:m,rpcpassword:h})))}),r.stdout.on("data",t=>{console.log("*"+t.toString()),t.toString().includes(o)&&(console.log("is-daemon-started fired"),s.webContents.send("is-daemon-started",{started:!0,network:b,rpcuser:m,rpcpassword:h}))}),r.stderr.on("data",function(t){console.log("stderr : "+t),t.toString().startsWith("Warning")||console.log(t.toString())})):(g=!1,s.webContents.send("is-daemon-started",{started:!1,network:b,rpcuser:m,rpcpassword:h}),console.log("Failed to start daemon."))})):(console.log(a),r=_.spawn(p.f_windows,f,c,function(i,x){i&&(g=!1,s.webContents.send("is-daemon-started",{started:!1,network:b,rpcuser:m,rpcpassword:h}),console.log(i),console.log("Failed to start daemon->"+i.message))}),r.on("error",i=>{g=!1,s.webContents.send("is-daemon-started",{started:!1,network:b,rpcuser:m,rpcpassword:h}),console.log("Failed to start daemon->"+i.message),console.log(i)}),r.pid!=null?(g=!0,s.webContents.send("is-daemon-started",{started:!0,network:b,rpcuser:m,rpcpassword:h}),console.log("Daemon started. PID:"+r.pid),r.on("exit",i=>{g=!1,r=null,console.log("Daemon stopped. Exit Code : "+i),l.app.quit(),process.exit(0)}),r.stdout.on("data",i=>{console.log("*"+i.toString()),i.toString().includes(o)&&(console.log("is-daemon-started fired"),s.webContents.send("is-daemon-started",{started:!0,network:b,rpcuser:m,rpcpassword:h}))}),r.stderr.on("data",function(i){console.log("stderr : "+i),i.toString().startsWith("Warning")||console.log(i.toString())})):(g=!1,s.webContents.send("is-daemon-started",{started:!1,network:b,rpcuser:m,rpcpassword:h}),console.log("Failed to start daemon.")))}function M(e){console.log("Stopping staker. PID : "+e),process.kill(e,"SIGTERM")}function L(e,n,d,p){console.log("Starting staker..."),console.log(`${e}`),console.log(`${n}`),console.log(`${d}`),console.log(`${p}`);let a=!1,o=__dirname;process.platform==="win32"&&(o+="\\"),process.platform==="darwin"&&(o+="/"),process.platform==="linux"&&(o+="/"),o+="bin";let c="",f={f_linux:"navio-staker",f_osx:"navio-staker",f_windows:"navio-staker.exe"},r="";process.platform=="win32"&&(r=o+"\\"+f.f_windows,a=!1),process.platform=="linux"&&(r=o+"/./"+f.f_linux,a=!0),process.platform=="darwin"&&(r=o+"/./"+f.f_osx,a=!0);var i=["-"+e+" -wallet="+n+" -rpcuser="+d+" -rpcpassword="+p];console.log("Binary Parameters : ["+i+"]");const x={cwd:o,env:process.env,shell:a,windowsVerbatimArguments:!0};console.log("Platform : "+process.platform),console.log("App Path : "+l.app.getAppPath()),console.log("Architecture : "+process.arch);var t;process.platform=="linux"||process.platform=="darwin"?(process.platform=="linux"&&(c=o+"/"+f.f_linux),process.platform=="darwin"&&(c=o+"/"+f.f_osx),console.log("Setting staker file as executable "+c),_.execFile("chmod +x "+c,null,x,function(u,I){t=_.spawn(r,i,x,function(w,U){w&&(console.log(w),console.log("Staker start failed->"+r+"->"+w.message))}),t.on("error",w=>{console.log("Failed to start staker->"+r+"->"+w.message)}),t.pid!=null?(s.webContents.send("start-staker-success",t.pid),console.log("Staker started. PID:"+t.pid),t.on("exit",w=>{t=null,s.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+w)}),t.stdout.on("data",w=>{console.log(w.toString())}),t.stderr.on("data",function(w){console.log("stderr : "+w),w.toString().startsWith("Warning")||console.log("Staker start failed->"+w.toString())})):console.log("Staker start failed.")})):(console.log(r),t=_.spawn(f.f_windows,i,x,function(u,I){u&&(console.log(u),console.log("Staker start failed -> "+u.message))}),t.on("error",u=>{console.log("Failed to start staker."+u.message),console.log(u)}),t.pid!=null?(s.webContents.send("start-staker-success",t.pid),console.log("Staker started. PID:"+t.pid),t.on("exit",u=>{t=null,s.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+u)}),t.stdout.on("data",u=>{console.log(u.toString())}),t.stderr.on("data",function(u){console.log("stderr : "+u),u.toString().startsWith("Warning")||console.log("Staker start failed",u.toString())})):console.log("Staker start failed."))}
