"use strict";const n=require("electron"),E=require("node:os"),_=require("node:path"),h=require("node:child_process"),k=require("crypto");process.env.DIST_ELECTRON=_.join(__dirname,"..");process.env.DIST=_.join(process.env.DIST_ELECTRON,"../dist");process.env.VITE_PUBLIC=process.env.VITE_DEV_SERVER_URL?_.join(process.env.DIST_ELECTRON,"../public/"):process.env.DIST;E.release().startsWith("6.1")&&n.app.disableHardwareAcceleration();process.platform==="win32"&&n.app.setAppUserModelId(n.app.getName());n.app.requestSingleInstanceLock()||(n.app.quit(),process.exit(0));let o=null;const I=_.join(__dirname,"../preload/index.js"),P=process.env.VITE_DEV_SERVER_URL,T=_.join(process.env.DIST,"index.html"),v=k.randomBytes(256),g=k.createHash("sha256").update(v,"utf8").digest("hex"),w=k.createHash("md5").update(v,"utf8").digest("hex"),m="testnet";var i=!1;async function D(){o=new n.BrowserWindow({title:"Main window",width:1100,height:760,icon:_.join(process.env.VITE_PUBLIC,"favicon.ico"),webPreferences:{preload:I,nodeIntegration:!0,contextIsolation:!1}}),o.setMenu(null),process.env.VITE_DEV_SERVER_URL?o.loadURL(P):o.loadFile(T),o.on("close",s=>{console.log("on-close"),console.log("is daemon binary started :"+i),i&&(console.log("stop-daemon fired"),s.preventDefault(),o.webContents.send("stop-daemon",5))}),o.webContents.on("did-finish-load",()=>{W(),o==null||o.webContents.send("main-process-message",new Date().toLocaleString())}),o.webContents.setWindowOpenHandler(({url:s})=>(s.startsWith("https:")&&n.shell.openExternal(s),{action:"deny"}))}n.app.whenReady().then(D);n.app.on("before-quit",s=>{i&&(console.log("before-quit"),s.preventDefault())});n.app.on("will-quit",s=>{i&&(console.log("will-quit"),s.preventDefault())});n.app.on("window-all-closed",()=>{o=null,process.platform!=="darwin"&&n.app.quit()});n.app.on("second-instance",()=>{o&&(o.isMinimized()&&o.restore(),o.focus())});n.app.on("activate",()=>{const s=n.BrowserWindow.getAllWindows();s.length?s[0].focus():D()});n.ipcMain.handle("start-staker",(s,r,x,f,c)=>{R(r,x,f,c)});n.ipcMain.handle("stop-staker",(s,r)=>{q(r)});n.ipcMain.handle("shell-open-item",(s,r)=>{n.shell.showItemInFolder(`${r}`)});function W(){let s=!1,r=__dirname;process.platform==="win32"&&(r+="\\"),process.platform==="darwin"&&(r+="/"),process.platform==="linux"&&(r+="/"),r+="bin";let x="",f={f_linux:"naviod",f_osx:"naviod",f_windows:"naviod.exe"},c="";process.platform=="win32"&&(c=r+"\\"+f.f_windows,s=!1),process.platform=="linux"&&(c=r+"/./"+f.f_linux,s=!0),process.platform=="darwin"&&(c=r+"/./"+f.f_osx,s=!0);const d="Starting HTTP server",b={cwd:r,env:process.env,shell:s,windowsVerbatimArguments:!0};var u=["--"+m+" --printtoconsole --walletcrosschain -rpcworkqueue=64 -rpcuser="+g+" -rpcpassword="+w+" -txindex=1 -addnode=testnet-navio.nav.community -debug=1 -debugexclude=libevent -debugexclude=http -debugexclude=rpc -debugexclude=leveldb -debugexclude=bench -debugexclude=net -debugexclude=addrman"];console.log("Daemon Parameters : ["+u+"]"),console.log("Platform : "+process.platform),console.log("Architecture : "+process.arch),console.log("App Path : "+n.app.getAppPath());var t;process.platform=="linux"||process.platform=="darwin"?(process.platform=="linux"&&(x=r+"/"+f.f_linux),process.platform=="darwin"&&(x=r+"/"+f.f_osx),console.log("Setting daemon file as executable "+x),h.execFile("chmod +x "+x,null,b,function(a,S){t=h.spawn(c,u,b,function(e,l){e&&(i=!1,console.log(e),console.log("Failed to start daemon->"+c+"->"+e.message))}),t.on("error",e=>{i=!1,console.log("Failed to start daemon->"+c+"->"+e.message),o.webContents.send("is-daemon-started",{started:!1,network:m,rpcuser:g,rpcpassword:w})}),t.pid!=null?(i=!0,console.log("Daemon started. PID:"+t.pid),t.on("exit",e=>{i&&(t=null,e!=127?(console.log("Daemon stopped. Exit Code : "+e),n.app.quit(),process.exit(0)):(i=!1,console.log("Daemon binary not found."),o.webContents.send("is-daemon-started",{started:!1,network:m,rpcuser:g,rpcpassword:w})))}),t.stdout.on("data",e=>{console.log("*"+e.toString()),e.toString().includes(d)&&(console.log("is-daemon-started fired"),o.webContents.send("is-daemon-started",{started:!0,network:m,rpcuser:g,rpcpassword:w}))}),t.stderr.on("data",function(e){console.log("stderr : "+e),e.toString().startsWith("Warning")||console.log(e.toString())})):(i=!1,o.webContents.send("is-daemon-started",{started:!1,network:m,rpcuser:g,rpcpassword:w}),console.log("Failed to start daemon."))})):(console.log(c),t=h.spawn(f.f_windows,u,b,function(a,S){a&&(i=!1,o.webContents.send("is-daemon-started",{started:!1,network:m,rpcuser:g,rpcpassword:w}),console.log(a),console.log("Failed to start daemon->"+a.message))}),t.on("error",a=>{i=!1,o.webContents.send("is-daemon-started",{started:!1,network:m,rpcuser:g,rpcpassword:w}),console.log("Failed to start daemon->"+a.message),console.log(a)}),t.pid!=null?(i=!0,o.webContents.send("is-daemon-started",{started:!0,network:m,rpcuser:g,rpcpassword:w}),console.log("Daemon started. PID:"+t.pid),t.on("exit",a=>{i=!1,t=null,console.log("Daemon stopped. Exit Code : "+a),n.app.quit(),process.exit(0)}),t.stdout.on("data",a=>{console.log("*"+a.toString()),a.toString().includes(d)&&(console.log("is-daemon-started fired"),o.webContents.send("is-daemon-started",{started:!0,network:m,rpcuser:g,rpcpassword:w}))}),t.stderr.on("data",function(a){console.log("stderr : "+a),a.toString().startsWith("Warning")||console.log(a.toString())})):(i=!1,o.webContents.send("is-daemon-started",{started:!1,network:m,rpcuser:g,rpcpassword:w}),console.log("Failed to start daemon.")))}function q(s){console.log("Stopping staker. PID : "+s),process.kill(s,"SIGTERM")}function R(s,r,x,f){console.log("Starting staker..."),console.log(`${s}`),console.log(`${r}`),console.log(`${x}`),console.log(`${f}`);let c=!1,d=__dirname;process.platform==="win32"&&(d+="\\"),process.platform==="darwin"&&(d+="/"),process.platform==="linux"&&(d+="/"),d+="bin";let b="",u={f_linux:"navio-staker",f_osx:"navio-staker",f_windows:"navio-staker.exe"},t="";process.platform=="win32"&&(t=d+"\\"+u.f_windows,c=!1),process.platform=="linux"&&(t=d+"/./"+u.f_linux,c=!0),process.platform=="darwin"&&(t=d+"/./"+u.f_osx,c=!0);var a=["-"+s+" -wallet="+r+" -rpcuser="+x+" -rpcpassword="+f];console.log("Binary Parameters : ["+a+"]");const S={cwd:d,env:process.env,shell:c,windowsVerbatimArguments:!0};console.log("Platform : "+process.platform),console.log("App Path : "+n.app.getAppPath()),console.log("Architecture : "+process.arch);var e;process.platform=="linux"||process.platform=="darwin"?(process.platform=="linux"&&(b=d+"/"+u.f_linux),process.platform=="darwin"&&(b=d+"/"+u.f_osx),console.log("Setting staker file as executable "+b),h.execFile("chmod +x "+b,null,S,function(l,C){e=h.spawn(t,a,S,function(p,y){p&&(console.log(p),console.log("Staker start failed->"+t+"->"+p.message))}),e.on("error",p=>{console.log("Failed to start staker->"+t+"->"+p.message)}),e.pid!=null?(o.webContents.send("start-staker-success",e.pid),console.log("Staker started. PID:"+e.pid),e.on("exit",p=>{e=null,o.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+p)}),e.stdout.on("data",p=>{console.log(p.toString())}),e.stderr.on("data",function(p){console.log("stderr : "+p),p.toString().startsWith("Warning")||console.log("Staker start failed->"+p.toString())})):console.log("Staker start failed.")})):(console.log(t),e=h.spawn(u.f_windows,a,S,function(l,C){l&&(console.log(l),console.log("Staker start failed -> "+l.message))}),e.on("error",l=>{console.log("Failed to start staker."+l.message),console.log(l)}),e.pid!=null?(o.webContents.send("start-staker-success",e.pid),console.log("Staker started. PID:"+e.pid),e.on("exit",l=>{e=null,o.webContents.send("stop-staker-success"),console.log("Staker stopped. Exit Code : "+l)}),e.stdout.on("data",l=>{console.log(l.toString())}),e.stderr.on("data",function(l){console.log("stderr : "+l),l.toString().startsWith("Warning")||console.log("Staker start failed",l.toString())})):console.log("Staker start failed."))}
